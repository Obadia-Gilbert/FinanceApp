@model FinanceApp.Application.Common.PagedResult<FinanceApp.Domain.Entities.Expense>

@{
    ViewData["Title"] = "Expenses";
}

<div class="mb-4">
    <h1 class="visually-hidden">Expenses</h1>
    <p class="page-subtitle mb-3">Review, add, and export your expense records.</p>
    <div class="d-flex gap-2 mb-3">
        <button id="btnAddExpense" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add New Expense
        </button>
        <a class="btn btn-success" asp-action="DownloadExcel">
            <i class="bi bi-download"></i> Download Excel
        </a>
    </div>

    <!-- Offcanvas container for create/edit forms -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="expenseOffcanvas" aria-labelledby="expenseOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 id="expenseOffcanvasLabel">Expense</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body px-0">
            <div class="p-3 d-flex align-items-center justify-content-center min-vh-25" id="expenseOffcanvasContent">
                <div class="text-center text-muted"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Loading…</div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table id="expenseTable" class="table table-hover mb-0" aria-label="List of expenses">
                <caption class="visually-hidden">List of expenses with description, amount, currency, category, date and actions</caption>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Currency</th>
                        <th>Category</th>
                        <th>Expense Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var expense in Model.Items)
                    {
                        <tr>
                            <td>@expense.Description</td>
                            <td>@expense.Amount</td>
                            <td>@expense.Currency</td>
                            <td>@expense.Category.Name</td>
                            <td>@expense.ExpenseDate.ToString("yyyy-MM-dd")</td>
                            <td>
                                <a class="btn btn-sm btn-warning btn-edit" href="@Url.Action("Edit", "Expense", new { id = expense.Id })" title="Edit" aria-label="Edit expense">
                                    <i class="bi bi-pencil" aria-hidden="true"></i>
                                </a>
                                <a class="btn btn-sm btn-danger btn-delete" href="@Url.Action("Delete", "Expense", new { id = expense.Id })" title="Delete" aria-label="Delete expense">
                                    <i class="bi bi-trash" aria-hidden="true"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function(){
            $('#expenseTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                pageLength: 10,
                language: {
                    search: "Filter:",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                }
            });
        });
    </script>
    <script>
        (function(){
            const btn = document.getElementById('btnAddExpense');
            if (!btn) return;

            btn.addEventListener('click', async function(e){
                e.preventDefault();
                const content = document.getElementById('expenseOffcanvasContent');
                const offcanvasEl = document.getElementById('expenseOffcanvas');
                const loadingHtml = '<div class="text-center text-muted py-4"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Loading…</div>';
                content.innerHTML = loadingHtml;
                if (offcanvasEl) { var o = new bootstrap.Offcanvas(offcanvasEl); o.show(); }
                const url = '@Url.Action("Create","Expense")?partial=true';
                const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
                if (!res.ok) {
                    if (typeof showToast === 'function') showToast('Unable to load form.'); else alert('Unable to load form.');
                    return;
                }
                const html = await res.text();
                content.innerHTML = html;
            });

            // Delegate table actions (edit & delete) to load partials into the same offcanvas
            document.querySelector('#expenseTable').addEventListener('click', async function(e){
                const editBtn = e.target.closest('.btn-edit');
                if (editBtn) {
                    e.preventDefault();
                    const href = editBtn.getAttribute('href');
                    if (!href) return;
                    const url = href + (href.indexOf('?') === -1 ? '?partial=true' : '&partial=true');
                    const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
                    if (!res.ok) { if (typeof showToast === 'function') showToast('Unable to load edit form.'); else alert('Unable to load edit form.'); return; }
                    const html = await res.text();
                    const content = document.getElementById('expenseOffcanvasContent');
                    content.innerHTML = html;
                    const offcanvasEl = document.getElementById('expenseOffcanvas');
                    const bsOff = new bootstrap.Offcanvas(offcanvasEl);
                    bsOff.show();
                    return;
                }

                const delBtn = e.target.closest('.btn-delete');
                if (delBtn) {
                    e.preventDefault();
                    const href = delBtn.getAttribute('href');
                    if (!href) return;
                    const url = href + (href.indexOf('?') === -1 ? '?partial=true' : '&partial=true');
                    const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
                    if (!res.ok) { if (typeof showToast === 'function') showToast('Unable to load delete confirmation.'); else alert('Unable to load delete confirmation.'); return; }
                    const html = await res.text();
                    const content = document.getElementById('expenseOffcanvasContent');
                    content.innerHTML = html;
                    const offcanvasEl = document.getElementById('expenseOffcanvas');
                    const bsOff = new bootstrap.Offcanvas(offcanvasEl);
                    bsOff.show();
                    return;
                }
            });
        })();
    </script>
}