@model FinanceApp.Web.Models.CategoryEditViewModel

@* Shared form partial for Edit - used in offcanvas (same UI as Create / mockup). *@

<form asp-action="Edit" method="post" class="category-form-offcanvas p-4" id="categoryEditForm">
    @if (Model?.Id != Guid.Empty)
    {
        <input type="hidden" asp-for="Id" />
    }

    <!-- Category Name -->
    <div class="mb-4">
        <label asp-for="Name" class="form-label fw-600">Category Name</label>
        <input asp-for="Name" class="form-control form-control-lg" placeholder="e.g. Groceries" />
        <span asp-validation-for="Name" class="invalid-feedback d-block small"></span>
    </div>

    <!-- Type (mockup-style) -->
    <div class="mb-4">
        <label class="form-label fw-600">Type</label>
        <div class="form-control form-control-lg bg-light text-muted">Expense</div>
    </div>

    <!-- Icon Selection -->
    <div class="mb-4">
        <label class="form-label fw-600">Select Icon</label>
        <div class="icon-picker-grid">
            @{
                var icons = new[] {
                    ("shopping-cart", "bag"),
                    ("utensils", "utensils"),
                    ("car", "car"),
                    ("home", "house"),
                    ("briefcase", "briefcase"),
                    ("tools", "wrench"),
                    ("film", "film"),
                    ("gamepad2", "gamepad2"),
                    ("heart", "heart"),
                    ("plane", "airplane"),
                    ("dumbbell", "dumbbell"),
                    ("hospital", "hospital")
                };
            }
            @foreach (var (iconName, displayName) in icons)
            {
                <button type="button" class="icon-option @(Model?.Icon == iconName ? "active" : "")" 
                        data-icon="@iconName" title="@displayName">
                    <i class="bi bi-@iconName fs-4"></i>
                </button>
            }
        </div>
        <input type="hidden" asp-for="Icon" id="selectedIcon" />
    </div>

    <!-- Badge Color -->
    <div class="mb-4">
        <label asp-for="BadgeColor" class="form-label fw-600">Badge Color</label>
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <input type="color" asp-for="BadgeColor" class="form-control form-control-color category-color-picker" style="width: 56px; height: 40px; padding: 2px;" />
            <input type="text" class="form-control" id="colorHex" placeholder="#137fec" value="@(Model?.BadgeColor ?? "#137fec")" style="max-width: 120px;" aria-label="Hex color" />
        </div>
        <small class="text-muted d-block mt-1">Choose a color for the category badge</small>
    </div>

    <!-- Description -->
    <div class="mb-4">
        <label asp-for="Description" class="form-label fw-600">Description</label>
        <textarea asp-for="Description" class="form-control" rows="3" placeholder="Add a short description for this category..."></textarea>
        <span asp-validation-for="Description" class="invalid-feedback d-block small"></span>
    </div>

    <!-- Buttons -->
    <div class="d-flex justify-content-end gap-2 pt-3 border-top">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
        <button type="submit" class="btn btn-primary fw-600" id="categoryEditSubmit">
            <span class="btn-text"><i class="bi bi-check-circle me-2"></i>Save Category</span>
            <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Savingâ€¦</span>
        </button>
    </div>
</form>
<script>
(function(){
    var container = document.getElementById('categoryOffcanvasContent') || document;
    if (typeof initCategoryForm === 'function') initCategoryForm(container);
    var form = container.querySelector('form.category-form-offcanvas');
    if (!form) return;
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        var submitBtn = document.getElementById('categoryEditSubmit');
        if (submitBtn) { submitBtn.querySelector('.btn-text')?.classList.add('d-none'); submitBtn.querySelector('.btn-loading')?.classList.remove('d-none'); submitBtn.disabled = true; }
        var formData = new FormData(form);
        var res = await fetch(form.getAttribute('action') || form.action, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: formData });
        var contentType = res.headers.get('content-type') || '';
        if (contentType.indexOf('application/json') !== -1) {
            var json = await res.json();
            if (json.success) {
                var offcanvasEl = document.getElementById('categoryOffcanvas');
                if (offcanvasEl) { var bs = bootstrap.Offcanvas.getInstance(offcanvasEl) || new bootstrap.Offcanvas(offcanvasEl); bs.hide(); }
                window.location.reload();
            }
            return;
        }
        var html = await res.text();
        var content = document.getElementById('categoryOffcanvasContent');
        if (content) { content.innerHTML = html; if (window.jQuery && jQuery.validator && jQuery.validator.unobtrusive) jQuery.validator.unobtrusive.parse(content); if (typeof initCategoryForm === 'function') initCategoryForm(content); }
        if (submitBtn) { submitBtn.querySelector('.btn-text')?.classList.remove('d-none'); submitBtn.querySelector('.btn-loading')?.classList.add('d-none'); submitBtn.disabled = false; }
    });
})();
</script>
