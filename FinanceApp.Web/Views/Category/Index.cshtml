@model FinanceApp.Application.Common.PagedResult<FinanceApp.Web.Models.CategoryViewModel>

@{
    ViewData["Title"] = "Categories";
}

<div class="mb-4">
    <h1 class="visually-hidden">Categories</h1>
    <p class="page-subtitle mb-3">Organize expenses with clear, reusable categories.</p>
    <button type="button" id="btnAddCategory" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Add New Category
    </button>
</div>

<!-- Offcanvas for category create/edit/delete (like Expense) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="categoryOffcanvas" aria-labelledby="categoryOffcanvasLabel">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-600" id="categoryOffcanvasLabel">Manage Financial Category</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body px-0">
        <div class="p-3 d-flex align-items-center justify-content-center min-vh-25" id="categoryOffcanvasContent">
            <div class="text-center text-muted"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Loading…</div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table id="categoryTable" class="table table-hover mb-0" aria-label="List of categories">
                <caption class="visually-hidden">List of categories with name, description and actions</caption>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th style="width: 220px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var category in Model.Items)
                    {
                        <tr>
                            <td>
                                @{ var bg = string.IsNullOrEmpty(category.BadgeColor) ? "#6c757d" : category.BadgeColor; }
                                <span class="category-badge" style="background:@bg; color:#fff;">
                                    @if (!string.IsNullOrEmpty(category.Icon))
                                    {
                                        <i class="bi bi-@category.Icon" style="color:#fff"></i>
                                    }
                                    @category.Name
                                </span>
                            </td>
                            <td>@category.Description</td>
                            <td>
                                <a class="btn btn-sm btn-warning btn-edit" href="@Url.Action("Edit", "Category", new { id = category.Id })" title="Edit" aria-label="Edit category">
                                    <i class="bi bi-pencil" aria-hidden="true"></i>
                                </a>
                                <a class="btn btn-sm btn-danger btn-delete" href="@Url.Action("Delete", "Category", new { id = category.Id })" title="Delete" aria-label="Delete category">
                                    <i class="bi bi-trash" aria-hidden="true"></i>
                                </a>
                                <a asp-controller="Expense" asp-action="ByCategory" asp-route-categoryId="@category.Id" class="btn btn-sm btn-info" title="View expenses" aria-label="View expenses in this category">
                                    <i class="bi bi-eye" aria-hidden="true"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function(){
            $('#categoryTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                pageLength: 10,
                language: {
                    search: "Filter:",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                }
            });

            // Add New Category: load create form in offcanvas (like Expense)
            document.getElementById('btnAddCategory')?.addEventListener('click', async function(e) {
                e.preventDefault();
                var content = document.getElementById('categoryOffcanvasContent');
                var label = document.getElementById('categoryOffcanvasLabel');
                var offcanvasEl = document.getElementById('categoryOffcanvas');
                if (label) label.textContent = 'Add Category';
                if (content) content.innerHTML = '<div class="text-center text-muted py-4"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Loading…</div>';
                if (offcanvasEl) { var o = new bootstrap.Offcanvas(offcanvasEl); o.show(); }
                var url = '@Url.Action("Create", "Category")?partial=true';
                var res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!res.ok) { if (typeof showToast === 'function') showToast('Unable to load form.'); else alert('Unable to load form.'); return; }
                var html = await res.text();
                if (content) content.innerHTML = html;
                if (typeof initCategoryForm === 'function') initCategoryForm(content || document);
            });

            // Delegate edit/delete clicks to offcanvas loader
            document.querySelector('#categoryTable').addEventListener('click', async function(e){
                const editBtn = e.target.closest('.btn-edit');
                if (editBtn) {
                    e.preventDefault();
                    const href = editBtn.getAttribute('href');
                    if (!href) return;
                    var label = document.getElementById('categoryOffcanvasLabel');
                    if (label) label.textContent = 'Edit Category';
                    const url = href + (href.indexOf('?') === -1 ? '?partial=true' : '&partial=true');
                    const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
                    if (!res.ok) { if (typeof showToast === 'function') showToast('Unable to load edit form.'); else alert('Unable to load edit form.'); return; }
                    const html = await res.text();
                    document.getElementById('categoryOffcanvasContent').innerHTML = html;
                    const offcanvasEl = document.getElementById('categoryOffcanvas');
                    const bsOff = new bootstrap.Offcanvas(offcanvasEl);
                    bsOff.show();
                    if (typeof initCategoryForm === 'function') initCategoryForm(document.getElementById('categoryOffcanvasContent') || document);
                    return;
                }

                const delBtn = e.target.closest('.btn-delete');
                if (delBtn) {
                    e.preventDefault();
                    const href = delBtn.getAttribute('href');
                    if (!href) return;
                    var label = document.getElementById('categoryOffcanvasLabel');
                    if (label) label.textContent = 'Delete Category';
                    const url = href + (href.indexOf('?') === -1 ? '?partial=true' : '&partial=true');
                    const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
                    if (!res.ok) { if (typeof showToast === 'function') showToast('Unable to load delete confirmation.'); else alert('Unable to load delete confirmation.'); return; }
                    const html = await res.text();
                    document.getElementById('categoryOffcanvasContent').innerHTML = html;
                    const offcanvasEl = document.getElementById('categoryOffcanvas');
                    const bsOff = new bootstrap.Offcanvas(offcanvasEl);
                    bsOff.show();
                    return;
                }
            });

        });
    </script>
}