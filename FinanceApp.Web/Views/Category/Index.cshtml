@model FinanceApp.Application.Common.PagedResult<FinanceApp.Web.Models.CategoryViewModel>

@{
    ViewData["Title"] = "Categories";
}

<div class="mb-4">
    <h1 class="h2 mb-3">Categories</h1>
    <a class="btn btn-primary" asp-action="Create">
        <i class="bi bi-plus-circle"></i> Add New Category
    </a>
</div>

<!-- Offcanvas for category actions -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="categoryOffcanvas" aria-labelledby="categoryOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 id="categoryOffcanvasLabel">Category</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body px-0">
        <div class="p-3" id="categoryOffcanvasContent">Loading...</div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table id="categoryTable" class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Icon</th>
                        <th style="width: 220px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var category in Model.Items)
                    {
                        <tr>
                            <td>
                                @{ var bg = string.IsNullOrEmpty(category.BadgeColor) ? "#6c757d" : category.BadgeColor; }
                                <span class="category-badge" style="background:@bg; color:#fff;">
                                    @if (!string.IsNullOrEmpty(category.Icon))
                                    {
                                        <i class="bi bi-@category.Icon" style="color:#fff"></i>
                                    }
                                    @category.Name
                                </span>
                            </td>
                            <td>@category.Description</td>
                            <td>
                                <a class="btn btn-sm btn-warning btn-edit" href="@Url.Action("Edit", "Category", new { id = category.Id })">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                                <a class="btn btn-sm btn-danger btn-delete" href="@Url.Action("Delete", "Category", new { id = category.Id })">
                                    <i class="bi bi-trash"></i> Delete
                                </a>
                                <a asp-controller="Expense" asp-action="ByCategory" asp-route-categoryId="@category.Id" class="btn btn-sm btn-info">
                                    <i class="bi bi-eye"></i> View
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function(){
            $('#categoryTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                pageLength: 10,
                language: {
                    search: "Filter:",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                }
            });

            // Delegate edit/delete clicks to offcanvas loader
            document.querySelector('#categoryTable').addEventListener('click', async function(e){
                const editBtn = e.target.closest('.btn-edit');
                if (editBtn) {
                    e.preventDefault();
                    const href = editBtn.getAttribute('href');
                    if (!href) return;
                    const url = href + (href.indexOf('?') === -1 ? '?partial=true' : '&partial=true');
                    const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
                    if (!res.ok) { alert('Unable to load edit form.'); return; }
                    const html = await res.text();
                    document.getElementById('categoryOffcanvasContent').innerHTML = html;
                    const offcanvasEl = document.getElementById('categoryOffcanvas');
                    const bsOff = new bootstrap.Offcanvas(offcanvasEl);
                    bsOff.show();
                    return;
                }

                const delBtn = e.target.closest('.btn-delete');
                if (delBtn) {
                    e.preventDefault();
                    const href = delBtn.getAttribute('href');
                    if (!href) return;
                    const url = href + (href.indexOf('?') === -1 ? '?partial=true' : '&partial=true');
                    const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
                    if (!res.ok) { alert('Unable to load delete confirmation.'); return; }
                    const html = await res.text();
                    document.getElementById('categoryOffcanvasContent').innerHTML = html;
                    const offcanvasEl = document.getElementById('categoryOffcanvas');
                    const bsOff = new bootstrap.Offcanvas(offcanvasEl);
                    bsOff.show();
                    return;
                }
            });

        });
    </script>
}