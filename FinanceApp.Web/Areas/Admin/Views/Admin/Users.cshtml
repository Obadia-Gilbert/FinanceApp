@model List<FinanceApp.Application.DTOs.UserDto>
@{
    ViewData["Title"] = "Manage Users";
    var currentUserId = ViewBag.CurrentUserId as string;
}

<div class="mb-4">
    <h1 class="visually-hidden">Manage Users</h1>
    <p class="page-subtitle mb-0">View and manage registered users. Admin only.</p>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover mb-0" aria-label="List of users">
                <caption class="visually-hidden">Users with email, name, role and actions</caption>
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th style="width: 200px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var u in Model)
                    {
                        <tr>
                            <td>
                                @if (!string.IsNullOrEmpty(u.ProfileImagePath))
                                {
                                    <img src="@u.ProfileImagePath" alt="" class="rounded-circle" style="width: 36px; height: 36px; object-fit: cover;" />
                                }
                                else
                                {
                                    var initial = string.IsNullOrWhiteSpace(u.FirstName) && string.IsNullOrWhiteSpace(u.LastName)
                                        ? (u.Email?.Length > 0 ? u.Email[0].ToString().ToUpperInvariant() : "?")
                                        : (u.FirstName?.Trim().Length > 0 ? u.FirstName.Trim()[0].ToString().ToUpperInvariant() : (u.LastName?.Trim().Length > 0 ? u.LastName.Trim()[0].ToString().ToUpperInvariant() : "?"));
                                    <span class="rounded-circle d-inline-flex align-items-center justify-content-center bg-secondary text-white" style="width: 36px; height: 36px; font-size: 0.9rem;">@initial</span>
                                }
                            </td>
                            <td>@(string.IsNullOrWhiteSpace(u.FirstName) && string.IsNullOrWhiteSpace(u.LastName) ? "â€”" : $"{u.FirstName?.Trim()} {u.LastName?.Trim()}".Trim())</td>
                            <td>@u.Email</td>
                            <td><span class="badge bg-primary">@u.Role</span></td>
                            <td>
                                <div class="d-flex flex-nowrap gap-1 align-items-center">
                                    @if (u.Role?.Contains("Admin") != true)
                                    {
                                        <form asp-action="AddToRole" method="post" class="d-inline" asp-route-id="@u.Id" asp-route-role="Admin">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-outline-primary" title="Grant admin rights">Make Admin</button>
                                        </form>
                                    }
                                    else if (!string.Equals(currentUserId, u.Id, StringComparison.Ordinal))
                                    {
                                        <form asp-action="RemoveFromRole" method="post" class="d-inline" asp-route-id="@u.Id" asp-route-role="Admin" onsubmit="return confirm('Remove admin rights from this user?');">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-outline-warning" title="Remove admin rights">Remove Admin</button>
                                        </form>
                                    }
                                    <form asp-action="Delete" method="post" class="d-inline" onsubmit="return confirm('Delete this user?');" asp-route-id="@u.Id">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete user" aria-label="Delete user">Delete</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @if (Model.Count == 0)
        {
            <p class="text-muted mb-0 py-4 text-center">No users found.</p>
        }
    </div>
</div>

<div class="mt-3">
    <a asp-controller="Home" asp-action="Index" asp-area="" class="btn btn-outline-secondary">Back to Dashboard</a>
</div>
